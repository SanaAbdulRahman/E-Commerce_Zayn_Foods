<!DOCTYPE html>
<html lang="en">

<head>
	<title>View Your complete Order History</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link rel="icon" type="image/png" href="images/icons/favicon.png" />

	<link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.min.css">

	<link rel="stylesheet" type="text/css" href="fonts/font-awesome-4.7.0/css/font-awesome.min.css">

	<link rel="stylesheet" type="text/css" href="fonts/iconic/css/material-design-iconic-font.min.css">

	<link rel="stylesheet" type="text/css" href="fonts/linearicons-v1.0.0/icon-font.min.css">

	<link rel="stylesheet" type="text/css" href="vendor/animate/animate.css">

	<link rel="stylesheet" type="text/css" href="vendor/css-hamburgers/hamburgers.min.css">

	<link rel="stylesheet" type="text/css" href="vendor/animsition/css/animsition.min.css">

	<link rel="stylesheet" type="text/css" href="vendor/select2/select2.min.css">

	<link rel="stylesheet" type="text/css" href="vendor/daterangepicker/daterangepicker.css">

	<link rel="stylesheet" type="text/css" href="vendor/slick/slick.css">

	<link rel="stylesheet" type="text/css" href="vendor/MagnificPopup/magnific-popup.css">

	<link rel="stylesheet" type="text/css" href="vendor/perfect-scrollbar/perfect-scrollbar.css">

	<link rel="stylesheet" type="text/css" href="stylesheets/util.css">
	<link rel="stylesheet" type="text/css" href="stylesheets/main.css">
	<link rel="stylesheet" href="stylesheets/style.css">

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
		integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

</head>

<body class="animsition">

	<!-- Header -->
	<header class="header-v4">
		<!-- Header desktop -->
		<div class="container-menu-desktop">
			<!-- Topbar -->
			<div class="top-bar">
				<div class="content-topbar flex-sb-m h-full container">
					<div class="left-top-bar p-l-22">
						Free shipping for orders above â‚¹499
					</div>
				</div>
			</div>

			<div class="wrap-menu-desktop">
				<nav class="limiter-menu-desktop container">

					<!-- Logo desktop -->
					<a href="#" class="logo">
						<img src="images/icons/logo-01.png" alt="IMG-LOGO">
					</a>

					<!-- Menu desktop -->
					<div class="menu-desktop">
						<ul class="main-menu">
							<li>
								<a href="/">Home</a>
							</li>

							<li>
								<a href="/dishes">Dishes</a>
							</li>

							<li class="active-menu">
								<a href="/orders">Orders</a>
							</li>

							<li>
								<a href="/about">About</a>
							</li>

							<li>
								<a href="/contact">Contact</a>
							</li>
						</ul>
					</div>

					<!-- Icon header -->
					<div class="wrap-icon-header flex-w flex-r-m m-r-15">

						<a href="/viewCart" class="icon-header-item cl2 hov-cl1 trans-04 p-r-11 p-l-10 icon-header-noti"
							data-notify="<%= cartDishCount %>">
							<i class="zmdi zmdi-shopping-cart"></i>
						</a>
						<!-- <a href="/myprofile"
							class="icon-header-item cl2 hov-cl1 trans-04 p-r-10 p-l-10 js-show-myaccount">
							<i class="zmdi zmdi-account"></i>
						</a> -->
						<div class="dropdown">
							<a href="#" class="icon-header-item cl2 hov-cl1 trans-04 p-r-10 p-l-22 dropdown-toggle"
								id="profileDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<i class="zmdi zmdi-account"></i>
							</a>
							<div class="dropdown-menu" aria-labelledby="profileDropdown">
								<a class="dropdown-item" href="/myprofile">My Profile</a>
								<!-- <a class="dropdown-item" href="/settings">Settings</a> -->
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="/getSignout">Logout</a>
							</div>
						</div>
					</div>
				</nav>
			</div>
		</div>

		<!-- Header Mobile -->
		<div class="wrap-header-mobile">
			<!-- Logo moblie -->
			<div class="logo-mobile">
				<a href="/index"><img src="images/icons/logo-01.png" alt="IMG-LOGO"></a>
			</div>

			<!-- Icon header -->
			<div class="wrap-icon-header flex-w flex-r-m m-r-15">

				<div class="icon-header-item cl2 hov-cl1 trans-04 p-r-11 p-l-10 icon-header-noti js-show-cart"
					data-notify="2">
					<i class="zmdi zmdi-shopping-cart"></i>
				</div>
				<div class="icon-header-item cl2 hov-cl1 trans-04 p-r-10 p-l-10 js-show-myaccount">
					<i class="zmdi zmdi-account"></i>
				</div>
			</div>

			<!-- Button show menu -->
			<div class="btn-show-menu-mobile hamburger hamburger--squeeze">
				<span class="hamburger-box">
					<span class="hamburger-inner"></span>
				</span>
			</div>
		</div>
		<!-- Menu Mobile -->
		<div class="menu-mobile">
			<ul class="main-menu-m">
				<li class="active-menu">
					<a href="">Home</a>
				</li>
				<li>
					<a href="/dishes">Dishes</a>
				</li>

				<li>
					<a href="/orders">Orders</a>
				</li>

				<li>
					<a href="/about">About</a>
				</li>

				<li>
					<a href="/contact">Contact</a>
				</li>
			</ul>
		</div>
	</header>

	<!-- My Account-->
	<!-- <div class="wrap-header-myaccount js-panel-myaccount">
		<div class="s-full js-hide-cart"></div>

		<div class="header-myaccount flex-col-l p-l-65 p-r-25">
			<div class="header-myaccount-title flex-w flex-sb-m p-b-8">
				<span class="mtext-103 cl2">
					vaajiee
				</span>

				<div class="fs-35 lh-10 cl2 p-lr-5 pointer hov-cl1 trans-04 js-hide-myaccount">
					<i class="zmdi zmdi-close"></i>
				</div>
			</div>
			<div class="header-myaccount-content flex-w js-pscroll">
				<ul class="w-full">
					<div class="cl2 mtext-101 p-b-27">
						<i class="zmdi zmdi-account"></i> <span class="stext-103 cl2 p-l-10">
							Abdul Vajid M
						</span>
					</div>
					<div class="cl2 mtext-101 p-b-27">
						<i class="zmdi zmdi-phone"></i> <span class="stext-103 cl2 p-l-10">
							09544251825
						</span>
					</div>
					<div class="cl2 mtext-101 p-b-27">
						<i class="zmdi zmdi-email"></i> <span class="stext-103 cl2 p-l-10">
							example@gmail.com
						</span>
					</div>
					<div class="cl2 mtext-101 p-b-27">
						<i class="zmdi zmdi-pin"></i> <span class="stext-103 cl2 p-l-10">
							Skyline Baywaters 4b
						</span>
						<p class="stext-103 cl2 p-l-25">
							Calicut Beach
						</p>
						<p class="stext-103 cl2 p-l-25">
							Near Calicut Corportion office
						</p>
						<p class="stext-103 cl2 p-l-25">
							Calicut,Kerala,India - 673001
						</p>
					</div>

				</ul>

				<div class="w-full">
					<button
						class="flex-c-m stext-101 cl0 size-111 bg1 bor1 hov-btn1 p-lr-15 trans-04 m-b-10 js-show-editInfo">
						<a>Edit Info</a>
					</button>
					<div class="header-myaccount-buttons flex-w w-full">
						<button
							class="flex-c-m stext-101 cl0 size-107 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-r-8 m-b-10 js-show-resetPassword">
							<a>Change Password</a>
						</button>
						<a href="shoping-cart.html"
							class="flex-c-m stext-101 cl0 size-105 bg3 bor2 hov-btn3 p-lr-15 trans-04 m-b-20">
							Sign Out
						</a>
					</div>
				</div>
			</div>
		</div>
	</div> -->

	<!-- Forgot Password-->
	<div class="wrap-header-myaccount js-panel-resetPassword">
		<div class="s-full js-resetPassword-"></div>

		<div class="header-myaccount flex-col-l p-l-65 p-r-25">
			<div class="header-myaccount-title flex-w flex-sb-m p-b-8">
				<span class="mtext-103 cl2">
					Reset Password
				</span>

				<div class="fs-35 lh-10 cl2 p-lr-5 pointer hov-cl1 trans-04 js-hide-resetPassword">
					<i class="zmdi zmdi-close"></i>
				</div>
			</div>

			<div class="header-myaccount-content flex-w js-pscroll">
				<ul class="header-myaccount-wrapitem w-full">
					<form>
						<span class="mtext-102 cl2">
							Current Password
						</span>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="password" name="password"
								placeholder="Enter your current password">
							<div class="focus-input1 trans-04"></div>
						</div>
						<span class="mtext-102 cl2">
							New Password
						</span>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="password" name="password"
								placeholder="Enter a strong password">
							<div class="focus-input1 trans-04"></div>
						</div>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="password" name="password"
								placeholder="Confirm your password">
							<div class="focus-input1 trans-04"></div>
						</div>
						<div class="p-t-18">
							<button class="flex-c-m stext-101 cl0 size-117 bg1 bor1 hov-btn1 p-lr-15 trans-04">
								Reset Password
							</button>
						</div>
					</form>
				</ul>
			</div>
		</div>
	</div>


	<!-- Edit info-->
	<div class="wrap-header-myaccount js-panel-editInfo">
		<div class="s-full js-hide-cart"></div>

		<div class="header-myaccount flex-col-l p-l-65 p-r-25">
			<div class="header-myaccount-title flex-w flex-sb-m p-b-8">
				<span class="mtext-103 cl2">
					Edit info
				</span>

				<div class="fs-35 lh-10 cl2 p-lr-5 pointer hov-cl1 trans-04 js-hide-editInfo">
					<i class="zmdi zmdi-close"></i>
				</div>
			</div>

			<div class="header-myaccount-content flex-w js-pscroll">
				<ul class="header-myaccount-wrapitem w-full">
					<form>
						<span class="mtext-102 cl2">
							Username
						</span>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="text" name="username"
								value="vaajiee">
							<div class="focus-input1 trans-04"></div>
						</div>
						<span class="mtext-102 cl2">
							Full Name
						</span>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="text" name="fullName"
								value="Abdul Vajid M">
							<div class="focus-input1 trans-04"></div>
						</div>
						<span class="mtext-102 cl2">
							Phone Number
						</span>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="text" name="phoneNumber"
								value="09876543210">
							<div class="focus-input1 trans-04"></div>
						</div>
						<span class="mtext-102 cl2">
							Email Id
						</span>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="text" name="email"
								value="vajidmohammed94@gmail.com">
							<div class="focus-input1 trans-04"></div>
						</div>
						<span class="mtext-102 cl2">
							Address
						</span>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="text" name="flatNo"
								value="Skyline Baywaters 4B">
							<div class="focus-input1 trans-04"></div>
						</div>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="text" name="street"
								value="Calicut Beach">
							<div class="focus-input1 trans-04"></div>
						</div>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="text" name="landmark"
								value="Near Calicut Corportion office">
							<div class="focus-input1 trans-04"></div>
						</div>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="text" name="district"
								value="Calicut">
							<div class="focus-input1 trans-04"></div>
						</div>
						<div class="wrap-input1 w-full p-b-4 mb-4 mt-2">
							<input class="input1 bg-none plh1 stext-107 cl2" type="text" name="pincode" value="673001">
							<div class="focus-input1 trans-04"></div>
						</div>
						<div class="p-t-18">
							<button class="flex-c-m stext-111 cl0 size-117 bg1 bor1 hov-btn1 p-lr-15 trans-04">
								Sign In
							</button>
						</div>
					</form>
				</ul>
			</div>
		</div>
	</div>

	<!-- OrdersNew -->

	<div class="container">
		<div class="row" style="text-align: center;">
			<!-- <div class="col-md-9 " id="orders" style="display: block;">
				<div class="row" style="text-align: center;"> -->
			<h1>Orders</h1>

			<% if(orders && orders.length>0){ %>
				<table class="table table-bordered text-center">
					<thead class="bg-secondary text-dark">
						<tr>
							<th>Order #</th>
							<th>Billing Name & Address</th>
							<th>Order Total</th>
							<th>Date</th>
							<th>Payment Method</th>
							<th>Order Status</th>
							<th>Actions</th>
							<th>Details</th>

						</tr>
					</thead>

					<tbody class="align-middle">
						<% orders.forEach((order)=> { %>

							<tr>
								<td class="align-middle">

									<%= order.orderId %>
								</td>
								<td class="align-middle">
									<% if (order.userId) { %>
										<%= `${order.userId.username || 'N/A' },${order.addressId.flatNo || 'N/A' },
											${order.addressId.street || 'N/A' }, ${order.addressId.landmark || 'N/A' },
											${order.addressId.district || 'N/A' }` %>
											<% } else { %>
												N/A
												<% } %>
								</td>
								<td class="align-middle">
									<%= order.billAmount %>
								</td>
								<td class="align-middle">
									<% const rawDate=new Date(order.createdAt); %>
										<% const year=rawDate.getFullYear(); %>
											<% const month=String(rawDate.getMonth() + 1).padStart(2, '0' ); %>
												<% const day=String(rawDate.getDate()).padStart(2, '0' ); %>
													<%= `${day}-${month}-${year}` %>
								</td>

								<td class="align-middle">
									<%= order.paymentMethod %>
								</td>
								<td class="align-middle">
									<%= order.orderStatus %>
								</td>
								<td class="align-middle">
									<%if(order.orderStatus !=="delivered" && order.orderStatus!=="cancelRequest" &&
										order.orderStatus!=="cancelled" ){%>
										<button class=" btn btn-danger"
											onclick=" orderCancel('<%=order.orderId%>',event)">Cancel</button>
										<%} %>


								</td>

								<td class="align-middle">
									<button class="btn" data-toggle="modal" data-target="#detail<%= order._id %>">
										View
									</button>
									<!-- view details -->

									<div class="modal fade" id="detail<%= order._id %>" tabindex="-1" role="dialog"
										aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
										<div class="modal-dialog modal-dialog-centered" role="document">




											<div class=" modal-content">
												<div class="modal-header text-center">
													<h5 class="modal-title" id="statusModalLabel" style="color: black;">
														OrderId - <%=order.orderId %>
													</h5>
													<button type="button" class="close" data-dismiss="modal"
														aria-label="Close">
														<span aria-hidden="true">&times;</span>
													</button>
												</div>
												<div class="modal-body">
													<table>
														<tr class="table_head">

															<th class="column-2">Order Items</th>
															<th class="column-3">Bill Amount</th>
															<th class="column-4">Date</th>
															<th class="column-5">Payment Status</th>

														</tr>

														<tr>

															<td class="column-2"
																style="width: 40% ; white-space: nowrap;">
																<% for(let i=0; i < order.orderItems.length; i++) { %>
																	<div class="how-itemcart1-1 p-b-5 p-t-5">
																		<div
																			style=" display: flex; justify-content: space-between;">
																			<img style="height: 20px;width: 20px;"
																				src="<%=order.orderItems[i].product.productImage1%>"
																				alt="IMG">
																			<span class="p-l-25">
																				<%=order.orderItems[i].product.productName%>
																					, <br>Qty:
																					<%=order.orderItems[i].quantity%>
																			</span>
																		</div>
																	</div>
																	<% } %>
															</td>

															<td>
																<%=order.billAmount%>
															</td>
															<td>
																<%= `${day}-${month}-${year}` %>
															</td>
															<td>
																<%=order.paymentMethod%><br>
																	<%=order.paymentStatus%>
															</td>

														</tr>

													</table>

													<div class="modal-footer">
														<button type="button" class="btn btn-secondary"
															data-dismiss="modal" style="color: black;">Close</button>

													</div>
												</div>


											</div>
										</div>
									</div>

								</td>

							</tr>

							<% }) %>

					</tbody>

				</table>
		</div>
	</div>

	<% }else{ %>
		<div class="card-body">
			<h4>No order data found</h4>
		</div>
		<% } %>

			<!--  pagination -->
			<% if (orders.length>0) { %>
				<nav aria-label="Dashboard Pagination">
					<ul class="pagination justify-content-center mt-5">
						<% if (current==1) { %>
							<li class="page-item disabled"><a href="#" class="page-link">First</a>
							</li>

							<% } else {%>
								<li class="page-item"><a href="/orders?page=1" class="page-link">First</a>
								</li>
								<% } %>
									<% var i=(Number(current)>3 ? Number(current)-2 :1)%>
										<% if (i!==1) { %>
											<li class="page-item disabled"><a href="#" class="page-link">...</a>
											</li>
											<% } %>
												<% for(; i<=Number(current)+2 && i<=pages;i++){ %>
													<% if (i==current) { %>
														<li class="page-item disabled"><a href="#" class="page-link">
																<%= i %>
															</a></li>
														<% } else {%>
															<li class="page-item"><a href="/orders?page=<%= i %>"
																	class="page-link">
																	<%= i %>
																</a></li>
															<% } %>
																<% if (i==Number(current)+2 && i<pages) { %>
																	<li class="page-item disabled">
																		<a href="#" class="page-link">
																			...
																		</a>
																	</li>
																	<% } %>

																		<% } %>

																			<% if (current==pages) { %>
																				<li class="page-item disabled">
																					<a href="#"
																						class="page-link">Last</a>
																				</li>

																				<% } else {%>
																					<li class="page-item">
																						<a href="/orders?page=<%= pages %>"
																							class="page-link">Last</a>
																					</li>
																					<% } %>

					</ul>
				</nav>

				<% } %>



					<!-- Footer -->
					<%- include('../partials/footer.ejs')%>


						<!-- Back to top -->
						<div class="btn-back-to-top" id="myBtn">
							<span class="symbol-btn-back-to-top">
								<i class="zmdi zmdi-chevron-up"></i>
							</span>
						</div>


						<script src="vendor/jquery/jquery-3.2.1.min.js"></script>

						<script src="vendor/animsition/js/animsition.min.js"></script>

						<script src="vendor/bootstrap/js/popper.js"></script>
						<script src="vendor/bootstrap/js/bootstrap.min.js"></script>

						<script src="vendor/select2/select2.min.js"></script>
						<script>
							$(".js-select2").each(function () {
								$(this).select2({
									minimumResultsForSearch: 20,
									dropdownParent: $(this).next('.dropDownSelect2')
								});
							})
						</script>

						<script src="vendor/MagnificPopup/jquery.magnific-popup.min.js"></script>

						<script src="vendor/perfect-scrollbar/perfect-scrollbar.min.js"></script>
						<script>
							$('.js-pscroll').each(function () {
								$(this).css('position', 'relative');
								$(this).css('overflow', 'hidden');
								var ps = new PerfectScrollbar(this, {
									wheelSpeed: 1,
									scrollingThreshold: 1000,
									wheelPropagation: false,
								});

								$(window).on('resize', function () {
									ps.update();
								})
							});
						</script>

						<script src="js/main.js"></script>
						<!-- Add this script to your HTML file -->
						<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

						<script>
							// Function to cancel the order via AJAX
							function orderCancel(orderId, event) {
								event.preventDefault();
								swal({
									title: "Are you sure?",
									text: "You want to cancel this order..?",
									icon: "warning",
									buttons: [
										'No',
										'Yes'
									],
									dangerMode: true,
								}).then(function (isConfirm) {
									console.log("swalisConfirm :", isConfirm);
									if (isConfirm) {
										$.ajax({
											type: 'POST',
											url: '/cancelOrder', // Replace this with the actual API endpoint for cancelling orders
											data: {
												orderId: orderId
											},
											success: function (response) {
												// Check the response from the server
												if (response.success) {
													// Update the order status in the table to "cancelled"
													var row = $('td:contains(' + orderId + ')').closest('tr');
													row.find('.column-5').html('<p style="color:red" class="cl1">Cancelled</p>');
													location.reload();
													// Optionally, you can show a success message to the user

													alert('Order has been cancelled successfully!');

												} else {
													// Optionally, you can show an error message to the user
													alert('Failed to cancel the order. Please try again.');
												}
											},
											error: function (xhr, status, error) {
												// Handle errors if the AJAX request fails
												console.error(xhr.responseText);
												alert('Failed to cancel the order. Please try again.');
											}
										});
									}
								});
								console.log("orderId", orderId);
								// Send an AJAX request to cancel the order
								//
							}
						</script>
						<script>
							$('button[data-toggle="modal"]').click(function () {
								$('#myModal').modal('show');
							});</script>
						<script src="vendor/sweetalert/sweetalert.min.js"></script>

						<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
							integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
							crossorigin="anonymous"></script>
</body>

</html>